// https://github.com/crossfilter/universe v0.8.1 Copyright 2019 Tanner Linsley
!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("crossfilter2"),require("reductio")):"function"==typeof define&&define.amd?define(["crossfilter2","reductio"],e):(n=n||self).universe=e(n.crossfilter,n.reductio)}(this,(function(n,e){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n,e=e&&e.hasOwnProperty("default")?e.default:e;var r={find:function(n,e){return n.find(e)},remove:function(n,e){return n.filter((function(r,t){return!!e(r)&&(n.splice(t,1),!0)}))},isArray:t,isObject:u,isBoolean:function(n){return"boolean"==typeof n},isString:function(n){return"string"==typeof n},isNumber:function(n){return"number"==typeof n},isFunction:i,get:function(n,e){t(e)&&(e=e.join("."));return e.replace("[",".").replace("]","").split(".").reduce((function(n,e){return n[e]}),n)},set:function(n,e,r){"string"==typeof e&&(e=e.replace("[",".").replace("]","").split("."));if(e.length>1){var t=e.shift();Object.assign(n[t]="[object Object]"===Object.prototype.toString.call(n[t])?n[t]:{},e,r)}else n[e[0]]=r},map:function(n,e){var r,t;if(i(e)){if(u(n)){for(t in r=[],n)n.hasOwnProperty(t)&&r.push(e(n[t],t,n));return r}return n.map(e)}if(u(n)){for(t in r=[],n)n.hasOwnProperty(t)&&r.push(n[t]);return r}return n.map((function(n){return n[e]}))},keys:function(n){return Object.keys(n)},sortBy:function(n,e){if(i(e))return n.sort((function(n,r){return e(n)>e(r)?1:e(n)<e(r)?-1:0}))},forEach:o,isUndefined:function(n){return void 0===n},pick:function(n,e){var r={};return o(e,(function(e){void 0!==n[e]&&(r[e]=n[e])})),r},xor:function(n,e){var r=[];return o(n,(function(n){if(-1===e.indexOf(n))return r.push(n)})),o(e,(function(e){if(-1===n.indexOf(e))return r.push(e)})),r},clone:a,isEqual:function n(e,r){if("object"==typeof e&&null!==e&&"object"==typeof r&&null!==r){if(Object.keys(e).length!==Object.keys(r).length)return!1;for(var t in e)return r.hasOwnProperty(t)&&n(e[t],r[t]),!1;return!0}if(e!==r)return!1;return!0},replaceArray:function(n,e){var r=n.length,t=e.length;r>t?n.splice(t,r-t):r<t&&n.push.apply(n,new Array(t-r));return o(n,(function(r,t){n[t]=e[t]})),n},uniq:function(n){var e=new Set;return n.filter((function(n){var r=!1;return e.has(n)||(e.add(n),r=!0),r}))},flatten:function(n){for(var e=[],r=0;r<n.length;++r)for(var t=n[r],u=0;u<t.length;++u)e.push(t[u]);return e},sort:function(n){for(var e=1;e<n.length;e++){for(var r=n[e],t=e;n[t-1]>r;)n[t]=n[t-1],--t;n[t]=r}return n},values:function(n){var e=[];for(var r in n)n.hasOwnProperty(r)&&e.push(n[r]);return e},recurseObject:function(n,e){return function n(r,t){for(var u in r){var i=a(t);if(i.push(u),"object"==typeof r[u]&&null!==r[u])n(r[u],i);else{if(!r.hasOwnProperty(u))continue;e(r[u],u,i)}}}(n,[]),n}};function t(n){return Array.isArray(n)}function u(n){return"object"==typeof n&&!t(n)}function i(n){return"function"==typeof n}function o(n,e){if(u(n))for(var r in n)n.hasOwnProperty(r)&&e(n[r],r,n);else if(t(n))return n.forEach(e)}function a(n){return JSON.parse(JSON.stringify(n,(function(n,e){return"function"==typeof e?e.toString():e})))}var c={$field:function(n,e){return n[e]},$and:function(n,e){e=e(n);for(var r=0;r<e.length;r++)if(!e[r])return!1;return!0},$or:function(n,e){e=e(n);for(var r=0;r<e.length;r++)if(e[r])return!0;return!1},$not:function(n,e){e=e(n);for(var r=0;r<e.length;r++)if(e[r])return!1;return!0},$eq:function(n,e){return n===e()},$gt:function(n,e){return n>e()},$gte:function(n,e){return n>=e()},$lt:function(n,e){return n<e()},$lte:function(n,e){return n<=e()},$ne:function(n,e){return n!==e()},$type:function(n,e){return typeof n===e()},$in:function(n,e){return n.indexOf(e())>-1},$nin:function(n,e){return-1===n.indexOf(e())},$contains:function(n,e){return e().indexOf(n)>-1},$excludes:function(n,e){return-1===e().indexOf(n)},$size:function(n,e){return n.length===e()}};var f={$sum:function(n){return n.reduce((function(n,e){return n+e}),0)},$avg:function(n){return n.reduce((function(n,e){return n+e}),0)/n.length},$max:function(n){return Math.max.apply(null,n)},$min:function(n){return Math.min.apply(null,n)},$count:function(n){return n.length},$first:function(n){return n[0]},$last:function(n){return n[n.length-1]},$get:d,$nth:d,$nthLast:function(n,e){return n[n.length-e]},$nthPct:function(n,e){return n[Math.round(n.length*(e/100))]},$map:function(n,e){return n.map((function(n){return n[e]}))}},s={makeValueAccessor:function(n){if("string"==typeof n){if(!p(n))return n;n=v(n)}if("number"==typeof n)return n;if(r.isObject(n))return e=l(n),function(n){return e(n)};var e},aggregators:f,extractKeyValOrArray:m,parseAggregatorParams:function(n){var e=[],r=n.indexOf("("),t=n.indexOf(")"),u=r>-1?n.substring(0,r):n;if(!f[u])return!1;r>-1&&t>-1&&t>r&&(e=n.substring(r+1,t).split(","));return{aggregator:f[u],params:e}}};function l(n){if(n=r.isObject(n)?m(n):n,r.isString(n))return p(n)?l(v(n)):function(e){return e[n]};if(r.isArray(n)){var e=r.map(n,l);return function(n){return e.map((function(e){return e(n)}))}}if(n.key){if(f[n.key]){var t=l(n.value);return function(e){return f[n.key](t(e))}}console.error("Could not find aggregration method",n)}return[]}function m(n){var e,r=[];for(var t in n)if({}.hasOwnProperty.call(n,t)){e={key:t,value:n[t]};var u={};u[t]=n[t],r.push(u)}return r.length>1?r:e}function p(n){return["$","("].indexOf(n.charAt(0))>-1}function v(n){var e=/\((.+)\)/g,r=/(?:\([^\(\)]*\))|(,)/g;return JSON.parse("{"+function n(t){t=t.replace(" ","");return'"'+t.replace(e,(function(e,t){if(r.test(t))return"$"===t.charAt(0)?'":{"'+t.replace(r,(function(e){return","===e?',"':n(e).trim()}))+"}":':["'+t.replace(r,(function(){return'","'}))+'"]'}))}(n)+"}")}function d(n,e){return n[e]}function y(n){return{filter:function(r,i,o,a){return e(r).then((function(e){var r=Object.assign({},n.filters),c=e.key;return"array"===e.complex&&(c=JSON.stringify(e.key)),"function"===e.complex&&(c=e.key.toString()),r[c]=t(i,o,a),u(r)}))},filterAll:function(i){if(!i)return n.columns.forEach((function(n){n.dimension.filterAll()})),u({});var o=Object.assign({},n.filters),a=r.map(i,(function(n){return e(n.column).then((function(e){var r=e.complex?JSON.stringify(e.key):e.key;o[r]=t(n.value,n.isRange,n.replace)}))}));return Promise.all(a).then((function(){return u(o)}))},applyFilters:u,makeFunction:o,scanForDynamicFilters:function(n){var e=[];return function n(t){r.forEach(t,(function(t,u){var o=i(t,u);o&&e.push(o),r.isString(t)&&(o=i(null,t))&&e.push(o),r.isObject(t)&&n(t)}))}(n.filter),e}};function e(e){var r=n.column.find(e);return new Promise((function(t,u){try{if(!r)return t(n.column({key:e,temporary:!0}).then((function(){return n.column.find(e)})));t(r)}catch(n){u(n)}}))}function t(n,e,t){return!r.isUndefined(n)&&(r.isFunction(n)?{value:n,function:n,replace:!0,type:"function"}:r.isObject(n)?{value:n,function:o(n),replace:!0,type:"function"}:r.isArray(n)?{value:n,replace:e||t,type:e?"range":"inclusive"}:{value:n,replace:t,type:"exact"})}function u(e){var t=r.map(e,(function(t,u){var i,o=n.filters[u];return t===o?Promise.resolve():(i="["===u.charAt(0)?n.column.find(JSON.parse(u)):n.column.find(u),t&&o&&!t.replace&&(e[u]=t=function(n,e){if("exact"===n.type&&"inclusive"===e.type)n.value=r.xor([n.value],e.value);else if("inclusive"===n.type&&"exact"===e.type)n.value=r.xor(n.value,[e.value]);else if("inclusive"===n.type&&"inclusive"===e.type)n.value=r.xor(n.value,e.value);else if("exact"===n.type&&"exact"===e.type){if(n.value===e.value)return!1;n.value=[n.value,e.value]}n.value.length?1===n.value.length?(n.type="exact",n.value=n.value[0]):n.type="inclusive":n=!1;return n}(t,o)),t?"exact"===t.type?Promise.resolve(i.dimension.filterExact(t.value)):"range"===t.type?Promise.resolve(i.dimension.filterRange(t.value)):"inclusive"===t.type?Promise.resolve(i.dimension.filterFunction((function(n){return t.value.indexOf(n)>-1}))):"function"===t.type?Promise.resolve(i.dimension.filterFunction(t.function)):Promise.resolve(i.dimension.filterAll()):Promise.resolve(i.dimension.filterAll()))}));return Promise.all(t).then((function(){n.filters=e;var t=[];return r.forEach(n.filters,(function(e,r){e||(t.push({key:r,val:e}),delete n.filters[r])})),Promise.all(r.map(t,(function(e){var r=n.column.find("["===e.key.charAt(0)?JSON.parse(e.key):e.key);if(r.temporary&&!r.dynamicReference)return n.clear(r.key)})))})).then((function(){return Promise.all(r.map(n.filterListeners,(function(n){return n()})))})).then((function(){return n}))}function i(n,e){return"$data"===e||(e&&"$column"===e?r.isString(n)?n:(console.warn('The value for filter "$column" must be a valid column key',n),!1):void 0)}function o(e,t){var u;if(r.isString(e)&&i(null,e)){var a=n.cf.all();return function(){return a}}return r.isString(e)||r.isNumber(e)||r.isBoolean(e)?function(n){return void 0===n?e:c.$eq(n,(function(){return e}))}:r.isArray(e)?(u=r.map(e,(function(n){return o(n,t)})),function(n){return u.map((function(e){return e(n)}))}):r.isObject(e)?(u=r.map(e,(function(e,r){var u=o(e,t),a=i(e,r);if(a){var f=n.column.find(a).values;return function(){return f}}if(c[r])return function(n){return c[r](n,u)};var l=s.parseAggregatorParams(r);return l?(u=o(e,t=!0),function(){return l.aggregator.apply(null,[u()].concat(l.params))}):function(n){return n=n[r],u(n,u)}})),t?1===u.length?function(n){return u[0](n)}:function(n){return r.map(u,(function(e){return e(n)}))}:function(n){return c.$and(n,(function(n){return r.map(u,(function(e){return e(n)}))}))}):(console.log("no expression found for ",e),!1)}}function g(n){var e=function(n){return{make:function(r,t,u){var i=e(r,u);return Promise.resolve(n.cf.dimension(i,"array"===t))},makeAccessor:e};function e(n,e){var t;if("string"===e)t=function(e){return r.get(e,n)};else if("function"===e)t=n;else if("array"===e){var u=r.map(n,(function(n){return"d['"+n+"']"}));t=new Function("d",String("return "+JSON.stringify(u).replace(/"/g,"")))}else t=!0===n?function(n,e){return e}:function(e){return e[n]};return t}}(n),t=function(e){r.isUndefined(e)&&(e=!0);r.isArray(e)||(e=[e]);return Promise.all(r.map(e,i)).then((function(){return n}))};return t.find=u,t;function u(e){return r.find(n.columns,(function(n){return r.isArray(e)?!r.xor(n.key,e).length:n.key===e}))}function i(t){var i=r.isObject(t)?t:{key:t},o=u(i.key);return o?(o.temporary=!1,o.dynamicReference&&(o.dynamicReference=!1),o.promise.then((function(){return n}))):(i.queries=[],n.columns.push(i),i.promise=new Promise((function(e,r){try{e(n.cf.all())}catch(n){r(n)}})).then((function(n){var t;if(r.isFunction(i.key))i.complex="function",t=i.key(n[0]);else if(r.isString(i.key)&&(i.key.indexOf(".")>-1||i.key.indexOf("[")>-1))i.complex="string",t=r.get(n[0],i.key);else if(r.isArray(i.key)){if(i.complex="array",(t=r.values(r.pick(n[0],i.key))).length!==i.key.length)throw new Error("Column key does not exist in data!",i.key)}else t=n[0][i.key];if(!i.complex&&!0!==i.key&&void 0===t)throw new Error("Column key does not exist in data!",i.key);return!0===i.key?i.type="all":i.complex?i.type="complex":i.array?i.type="array":i.type=function(n){return r.isNumber(n)?"number":r.isBoolean(n)?"bool":r.isArray(n)?"array":r.isObject(n)?"object":"string"}(t),e.make(i.key,i.type,i.complex)})).then((function(t){i.dimension=t,i.filterCount=0;var u=n.onDataChange(o);return i.removeListeners=[u],o();function o(n){if(!0===i.key)return Promise.resolve();var t=e.makeAccessor(i.key,i.complex);return i.values=i.values||[],new Promise((function(e,r){try{n&&n.added?e(n.added):e(i.dimension.bottom(1/0))}catch(n){r(n)}})).then((function(n){var e;e="string"===i.complex||"function"===i.complex?r.map(n,t):"array"===i.type?r.flatten(r.map(n,t)):r.map(n,t),i.values=r.uniq(i.values.concat(e))}))}})),i.promise.then((function(){return n})))}}var h={shorthandLabels:{$count:"count",$sum:"sum",$avg:"avg",$min:"min",$max:"max",$med:"med",$sumSq:"sumSq",$std:"std"},aggregators:{$count:function(n){return n.count(!0)},$sum:function(n,e){return n.sum(e)},$avg:function(n,e){return n.avg(e)},$min:function(n,e){return n.min(e)},$max:function(n,e){return n.max(e)},$med:function(n,e){return n.median(e)},$sumSq:function(n,e){return n.sumOfSq(e)},$std:function(n,e){return n.std(e)},$valueList:function(n,e){return n.valueList(e)},$dataList:function(n){return n.dataList(!0)}}};function k(n){return n.locked?r.clone(n.data):n.data}function O(n){var t=function(n){var t=y(n);return function(n){var u=e();if(function n(e,t){var u=r.sortBy(r.map(t,(function(n,e){return{key:e,value:n}})),(function(n){return h.aggregators[n.key]?0:1}));return r.forEach(u,(function(t){if(h.aggregators[t.key]){var u=s.makeValueAccessor(t.value);e=h.aggregators[t.key](e,u)}else r.isObject(t.value)?n(e.value(t.key),t.value):console.error("Nested selects must be an object",t.key)}))}(u,n.select),n.filter){var i=t.makeFunction(n.filter);i&&u.filter(i)}return Promise.resolve(u)}}(n),u=y(n),i={post:function(n,e,r){return n.data=k(e),Promise.resolve(r(n,e))},sortByKey:function(n,e,t){n.data=k(e),n.data=r.sortBy(n.data,(function(n){return n.key})),t&&n.data.reverse()},limit:function(n,e,t,u){n.data=k(e),r.isUndefined(u)?(u=t||0,t=0):(t=t||0,u=u||n.data.length),n.data=n.data.splice(t,u-t)},squash:function(n,e,t,u,i,o){n.data=k(e),t=t||0,u=u||n.data.length;var a=n.data.splice(t,u-t),c={key:o||"Other",value:{}};r.recurseObject(i,(function(n,e,t){var u=[];r.forEach(a,(function(n){u.push(r.get(n.value,t))})),r.set(c.value,t,s.aggregators[n](u))})),n.data.splice(t,0,c)},change:function(n,e,t,u,i){n.data=k(e),t=t||0,u=u||n.data.length;var o={key:[n.data[t].key,n.data[u].key],value:{}};r.recurseObject(i,(function(e,i,a){var c=r.clone(a);c.pop(),c.push(i+"Change"),r.set(o.value,c,r.get(n.data[u].value,a)-r.get(n.data[t].value,a))})),n.data=o},changeMap:function(n,e,t,u){u=r.isUndefined(u)?0:u,n.data=k(e),r.recurseObject(t,(function(e,t,i){var o=r.clone(i),a=r.clone(i),c=r.clone(i);o.pop(),a.pop(),c.pop(),o.push(t+"Change"),a.push(t+"ChangeFromStart"),c.push(t+"ChangeFromEnd");var f=r.get(n.data[0].value,i,u),s=r.get(n.data[n.data.length-1].value,i,u);r.forEach(n.data,(function(e,t){var l=n.data[t-1]||n.data[0];r.set(n.data[t].value,o,r.get(e.value,i,u)-(l?r.get(l.value,i,u):u)),r.set(n.data[t].value,a,r.get(e.value,i,u)-f),r.set(n.data[t].value,c,r.get(e.value,i,u)-s)}))}))}},o=r.keys(i);return function(e){for(var a=JSON.stringify(e),c=0;c<n.columns.length;c++)for(var f=0;f<n.columns[c].queries.length;f++)if(n.columns[c].queries[f].hash===a)return new Promise((function(e,r){try{e(n.columns[c].queries[f])}catch(n){r(n)}}));var s={original:e,hash:a};return r.isUndefined(s.original)&&(s.original={}),r.isUndefined(s.original.select)&&(s.original.select={$count:!0}),s.original.groupBy=s.original.groupBy||!0,function(e){return n.column({key:e.original.groupBy,type:r.isUndefined(e.type)?null:e.type,array:Boolean(e.array)}).then((function(){var r=n.column.find(e.original.groupBy);return e.column=r,r.queries.push(e),r.removeListeners.push((function(){return e.clear()})),e}))}(s=function e(t,u){var a=!1;u||(u=t,t={},a=!0);Object.assign(t,{universe:n,crossfilter:n.cf,parent:u,column:u.column,dimension:u.dimension,group:u.group,reducer:u.reducer,original:u.original,hash:u.hash,removeListeners:[],postAggregations:[],locked:a,lock:function(n){if(!r.isUndefined(n))return void(t.locked=Boolean(n));t.locked=!0},unlock:function(){t.locked=!1},clear:function(){return r.forEach(t.removeListeners,(function(n){n()})),new Promise((function(n,e){try{n(t.group.dispose())}catch(n){e(n)}})).then((function(){if(t.column.queries.splice(t.column.queries.indexOf(t),1),!t.column.queries.length)return n.clear(t.column.key)})).then((function(){return n}))}});r.forEach(o,(function(n){var r;t[n]=(r=i[n],function(){var n=Array.prototype.slice.call(arguments),u={};return e(u,t),n.unshift(u,t),t.postAggregations.push((function(){Promise.resolve(r.apply(null,n)).then(i)})),Promise.resolve(r.apply(null,n)).then(i);function i(){return v(u).then((function(){return u}))}})}));return t}(s)).then((function(n){return Promise.resolve(n.column.dimension.group()).then((function(e){return n.group=e,n}))})).then((function(e){var t=u.scanForDynamicFilters(e.original);if(t.length)return Promise.all(r.map(t,(function(r){return n.column({key:r,dynamicReference:e.group})}))).then((function(){return e}));return e})).then((function(e){var r=n.onDataChange((function(){return l(e)}));e.removeListeners.push(r);var t=n.onFilter((function(){return v(e)}));return e.removeListeners.push(t),e})).then(l);function l(n){return function(n){return t(n.original).then((function(e){return n.reducer=e,n}))}(n).then(m).then(p).then(v)}function m(n){return Promise.resolve(n.reducer(n.group)).then((function(){return n}))}function p(n){return Promise.resolve(n.group.all()).then((function(e){return n.data=e,n}))}function v(n){return n.postAggregations.length>1&&(n.locked=!0),Promise.all(r.map(n.postAggregations,(function(n){return n()}))).then((function(){return n}))}}}function x(n){return function(e){return e&&(e=r.isArray(e)?e:[e]),e?Promise.all(r.map(e,(function(e){r.isObject(e)&&(e=e.key);var u=r.remove(n.columns,(function(n){return r.isArray(e)?!r.xor(n.key,e).length:n.key===e?!n.dynamicReference:void 0}))[0];u&&t(u)}))).then((function(){return n})):Promise.all(r.map(n.columns,t)).then((function(){return n.columns=[],n}));function t(e){var t=[];e.removeListeners&&(t=r.map(e.removeListeners,(function(n){return Promise.resolve(n())})));var u=e.key;return"array"===e.complex&&(u=JSON.stringify(e.key)),"function"===e.complex&&(u=e.key.toString()),delete n.filters[u],e.dimension&&t.push(Promise.resolve(e.dimension.dispose())),Promise.all(t)}}}function P(n){return function(){return n.clear().then((function(){return n.cf.dataListeners=[],n.cf.filterListeners=[],Promise.resolve(n.cf.remove())})).then((function(){return n}))}}return function(e,t){var u={options:Object.assign({},t),columns:[],filters:{},dataListeners:[],filterListeners:[]},i=function(e){return{build:function(e){if(r.isArray(e))return Promise.resolve(n(e));if(!e||"function"!=typeof e.dimension)return Promise.reject(new Error("No Crossfilter data or instance found!"));return Promise.resolve(e)},generateColumns:t,add:function(n){return n=t(n),new Promise((function(r,t){try{r(e.cf.add(n))}catch(n){t(n)}})).then((function(){return r.map(e.dataListeners,(function(e){return function(){return e({added:n})}})).reduce((function(n,e){return n.then(e)}),Promise.resolve(!0))})).then((function(){return Promise.all(r.map(e.filterListeners,(function(n){return n()})))})).then((function(){return e}))},remove:function(n){return new Promise((function(r,t){try{r(e.cf.remove(n))}catch(n){t(n)}})).then((function(){return Promise.all(r.map(e.filterListeners,(function(n){return n()})))})).then((function(){return e}))}};function t(n){return e.options.generatedColumns?r.map(n,(function(n){return r.forEach(e.options.generatedColumns,(function(e,r){n[r]=e(n)})),n})):n}}(u),o=y(u);return e=i.generateColumns(e),i.build(e).then((function(n){return u.cf=n,Object.assign(u,{add:i.add,remove:i.remove,column:g(u),query:O(u),filter:o.filter,filterAll:o.filterAll,applyFilters:o.applyFilters,clear:x(u),destroy:P(u),onDataChange:a,onFilter:c})}));function a(n){return u.dataListeners.push(n),function(){u.dataListeners.splice(u.dataListeners.indexOf(n),1)}}function c(n){return u.filterListeners.push(n),function(){u.filterListeners.splice(u.filterListeners.indexOf(n),1)}}}}));
